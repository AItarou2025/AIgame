<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã©ã†ã¶ã¤ã‚¿ãƒ¯ãƒ¼</title>
<style>
body{margin:0;background:#eef;overflow:hidden}
.screen{
  position:fixed;inset:0;
  background:rgba(240,240,255,.96);
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  z-index:10
}
.hidden{display:none}
#ui{
  position:fixed;top:10px;width:100%;
  text-align:center;font-size:22px;z-index:5
}
#event{margin-top:6px;font-size:18px;color:#d33}
button{font-size:20px;padding:10px 20px}
</style>
</head>
<body>

<div id="title" class="screen">
  <h1>ğŸ¾ ã©ã†ã¶ã¤ã‚¿ãƒ¯ãƒ¼</h1>
  <button onclick="startGame(event)">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
</div>

<div id="over" class="screen hidden">
  <h1>ğŸ’¥ ããšã‚ŒãŸï¼</h1>
  <p>ã‚¹ã‚³ã‚¢ï¼š<span id="final"></span></p>
  <button onclick="location.reload()">ã‚‚ã†ä¸€å›</button>
</div>

<div id="ui" class="hidden">
  â± <span id="timer">5.0</span>
  ï¼ ã‚¹ã‚³ã‚¢ <span id="score">0</span>
  <div id="event"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
<script>
const {Engine,Render,Runner,World,Bodies,Body,Events} = Matter;

let engine, render, runner;
let current=null;
let phase="idle";
let startTime=0;
let score=0;

let wind=null;
let nextEvent=null;
let fallTimer=null;

const LIMIT=5000;
const FAIL_Y=620;

const animals=[
  {emoji:"ğŸ˜",w:80,h:50,d:0.004},
  {emoji:"ğŸ§",w:60,h:60,d:0.002},
  {emoji:"ğŸ°",w:50,h:40,d:0.0015},
  {emoji:"ğŸ",w:90,h:30,d:0.001}
];

/* ===== åˆæœŸåŒ– ===== */
function init(){
  engine=Engine.create();
  engine.gravity.y=1;

  render=Render.create({
    element:document.body,
    engine,
    options:{width:400,height:600,wireframes:false,background:"#fff"}
  });

  runner=Runner.create();
  Runner.run(runner,engine);
  Render.run(render);

  World.add(engine.world,
    Bodies.rectangle(200,590,160,18,{isStatic:true,angle:0.02})
  );

  setupEvents();
}

/* ===== å‡ºç¾ ===== */
function spawn(){
  phase="control";
  wind=null;
  document.getElementById("event").textContent="";

  // ğŸŒª äºˆå‘Š
  if(Math.random()<0.3){
    const dir=Math.random()<0.5?-1:1;
    nextEvent={type:"wind",dir};
    document.getElementById("event").textContent=
      dir<0?"ğŸŒª å·¦é¢¨ äºˆå‘Š":"ğŸŒª å³é¢¨ äºˆå‘Š";
  }else nextEvent=null;

  // ğŸ’£ or ğŸ¾
  if(Math.random()<0.2){
    current=Bodies.circle(200,120,28,{
      isStatic:true,
      render:{text:"ğŸ’£"},
      isBomb:true
    });
  }else{
    const a=animals[Math.random()*animals.length|0];
    current=Bodies.rectangle(200,120,a.w,a.h,{
      isStatic:true,
      density:a.d,
      friction:0.5,
      render:{text:a.emoji}
    });
  }

  World.add(engine.world,current);
  startTime=Date.now();
}

/* ===== æ“ä½œ ===== */
document.addEventListener("keydown",e=>{
  if(phase!=="control")return;
  if(e.key==="ArrowLeft")Body.translate(current,{x:-12,y:0});
  if(e.key==="ArrowRight")Body.translate(current,{x:12,y:0});
  if(e.key===" ")drop();
});
document.addEventListener("click",()=>{
  if(phase==="control")drop();
});

/* ===== è½ã¨ã™ ===== */
function drop(){
  if(phase!=="control")return;
  Body.setStatic(current,false);
  phase="falling";
  score++;
  document.getElementById("score").textContent=score;

  // ğŸŒª ç™ºå‹•
  if(nextEvent){
    wind={
      dir:nextEvent.dir,
      power:0.0006, // â˜… å¼±ä½“åŒ–
      end:Date.now()+1800
    };
    document.getElementById("event").textContent="ğŸŒª é¢¨ ç™ºç”Ÿä¸­";
    nextEvent=null;
  }

  // ğŸ’£
  if(current.isBomb){
    setTimeout(explode,1000);
  }
}

/* ===== çˆ†ç™º ===== */
function explode(){
  if(!current)return;
  engine.world.bodies.forEach(b=>{
    if(b===current||b.isStatic)return;
    const dx=b.position.x-current.position.x;
    const dy=b.position.y-current.position.y;
    const dist=Math.sqrt(dx*dx+dy*dy)+0.1;
    const force=0.03/dist;
    Body.applyForce(b,b.position,{x:dx*force,y:dy*force});
  });
  World.remove(engine.world,current);
  current=null;
  spawn(); // â˜… å¿…ãšæ¬¡ã¸
}

/* ===== åˆ¤å®š ===== */
function setupEvents(){

  Events.on(engine,"beforeUpdate",()=>{
    // ã‚¿ã‚¤ãƒãƒ¼
    if(phase==="control"){
      const r=LIMIT-(Date.now()-startTime);
      document.getElementById("timer").textContent=
        Math.max(0,r/1000).toFixed(1);
      if(r<=0)drop();
    }

    // ğŸŒª é¢¨
    if(wind){
      if(current)
        Body.applyForce(current,current.position,
          {x:wind.dir*wind.power,y:0});
      if(Date.now()>wind.end){
        wind=null;
        document.getElementById("event").textContent="ğŸŒª é¢¨ çµ‚äº†";
      }
    }
  });

  Events.on(engine,"afterUpdate",()=>{
    if(phase!=="falling"||!current)return;

    // ä¸‹ã«è½ã¡ãŸã‚‰çŒ¶äºˆ
    if(current.position.y>FAIL_Y){
      if(!fallTimer){
        fallTimer=setTimeout(gameOver,800);
      }
    }else{
      clearTimeout(fallTimer);
      fallTimer=null;
    }

    // å®‰å®š
    if(current.speed<0.15){
      clearTimeout(fallTimer);
      fallTimer=null;
      current=null;
      spawn();
    }
  });

  // æç”»
  Events.on(render,"afterRender",()=>{
    const ctx=render.context;
    ctx.font="32px serif";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    engine.world.bodies.forEach(b=>{
      if(!b.render.text)return;
      ctx.strokeStyle="#000";
      ctx.lineWidth=4;
      ctx.strokeText(b.render.text,b.position.x,b.position.y);
      ctx.fillStyle="#fff";
      ctx.fillText(b.render.text,b.position.x,b.position.y);
    });
  });
}

/* ===== ç”»é¢ ===== */
function startGame(e){
  e.stopPropagation();
  document.getElementById("title").classList.add("hidden");
  document.getElementById("ui").classList.remove("hidden");
  score=0;
  document.getElementById("score").textContent=0;
  init();
  spawn();
}
function gameOver(){
  phase="gameover";
  document.getElementById("final").textContent=score;
  document.getElementById("over").classList.remove("hidden");
}
</script>
</body>
</html>
