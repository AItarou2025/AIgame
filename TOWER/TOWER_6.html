<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã©ã†ã¶ã¤ã‚¿ãƒ¯ãƒ¼ãƒãƒˆãƒ«</title>
<style>
body {
  margin: 0;
  background: #eef;
  font-family: sans-serif;
  overflow: hidden;
}
.screen {
  position: fixed;
  inset: 0;
  background: rgba(238,238,255,0.96);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 10;
}
.hidden { display: none; }

#ui {
  position: fixed;
  top: 8px;
  width: 100%;
  text-align: center;
  z-index: 5;
}
#timer { font-size: 26px; font-weight: bold; }
canvas { display:block; }
</style>
</head>
<body>

<div id="titleScreen" class="screen">
  <h1>ğŸ¾ ã©ã†ã¶ã¤ã‚¿ãƒ¯ãƒ¼ãƒãƒˆãƒ«</h1>
  <button onclick="startGame(event)">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
</div>

<div id="gameOverScreen" class="screen hidden">
  <h1>ğŸ’¥ ããšã‚ŒãŸï¼</h1>
  <p>ã‚¹ã‚³ã‚¢ï¼š<span id="finalScore"></span></p>
  <button onclick="location.reload()">ğŸ” ã‚‚ã†ä¸€å›</button>
</div>

<div id="ui" class="hidden">
  â± <span id="timer">5.0</span>
  ã‚¹ã‚³ã‚¢: <span id="score">0</span>
</div>

<script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
<script>
const { Engine, Render, Runner, World, Bodies, Body, Events } = Matter;

/* ===== çŠ¶æ…‹ ===== */
let engine, render, runner;
let currentAnimal = null;
let lastDropped = null;
let gameActive = false;
let isDropping = false;
let dropStartTime = 0;
let outTimer = null;
let score = 0;

const DROP_LIMIT = 5000;

/* ===== åˆæœŸåŒ– ===== */
function init() {
  engine = Engine.create();
  engine.gravity.y = 1;

  render = Render.create({
    element: document.body,
    engine,
    options: {
      width: 400,
      height: 600,
      wireframes: false,
      background: "#fff"
    }
  });

  runner = Runner.create();
  Runner.run(runner, engine);
  Render.run(render);

  World.add(engine.world,
    Bodies.rectangle(200, 585, 160, 20, {
      isStatic: true, friction: 0.6
    })
  );

  setupEvents();
}

/* ===== å‹•ç‰© ===== */
const animals = ["ğŸ˜","ğŸ§","ğŸ°","ğŸ"];

/* ===== ã‚¹ãƒãƒ¼ãƒ³ ===== */
function spawnAnimal() {
  if (!gameActive) return;

  isDropping = false;

  currentAnimal = Bodies.rectangle(200, 120, 70, 40, {
    density: 0.002,
    friction: 0.4,
    render:{ text: animals[Math.floor(Math.random()*animals.length)] }
  });

  World.add(engine.world, currentAnimal);
  dropStartTime = Date.now();
  document.getElementById("timer").textContent = "5.0";
}

/* ===== æ“ä½œ ===== */
document.addEventListener("keydown", e=>{
  if (!gameActive || !currentAnimal || isDropping) return;

  if (e.key==="ArrowLeft") Body.translate(currentAnimal,{x:-10,y:0});
  if (e.key==="ArrowRight") Body.translate(currentAnimal,{x:10,y:0});
  if (e.key===" ") drop();
});

document.addEventListener("click", ()=>{
  if (!gameActive || !currentAnimal || isDropping) return;
  drop();
});

/* ===== è½ã¨ã™ ===== */
function drop() {
  isDropping = true;
  lastDropped = currentAnimal;
  currentAnimal = null;
  score++;
  document.getElementById("score").textContent = score;
  document.getElementById("timer").textContent = "--";
  setTimeout(spawnAnimal, 600);
}

/* ===== åˆ¤å®š ===== */
function setupEvents() {

  // ã‚¿ã‚¤ãƒãƒ¼
  Events.on(engine,"beforeUpdate",()=>{
    if (!gameActive || !currentAnimal || isDropping) return;
    const r = Math.max(0, DROP_LIMIT - (Date.now()-dropStartTime));
    document.getElementById("timer").textContent = (r/1000).toFixed(1);
    if (r === 0) drop();
  });

  // ãƒŸã‚¹åˆ¤å®šã¯ã€Œæœ€å¾Œã«è½ã¨ã—ãŸå‹•ç‰©ã ã‘ã€
  Events.on(engine,"afterUpdate",()=>{
    if (!gameActive || !lastDropped) return;

    const b = lastDropped;
    const out =
      b.position.x < 80 ||
      b.position.x > 320 ||
      b.position.y > 650;

    if (out && !outTimer) {
      outTimer = setTimeout(gameOver, 2000);
    }

    if (!out && outTimer) {
      clearTimeout(outTimer);
      outTimer = null;
    }
  });

  // çµµæ–‡å­—æç”»
  Events.on(render,"afterRender",()=>{
    const ctx = render.context;
    ctx.font="32px serif";
    ctx.textAlign="center";
    ctx.textBaseline="middle";

    engine.world.bodies.forEach(b=>{
      if (!b.render.text) return;
      ctx.lineWidth=4;
      ctx.strokeStyle="#000";
      ctx.strokeText(b.render.text,b.position.x,b.position.y);
      ctx.fillStyle="#fff";
      ctx.fillText(b.render.text,b.position.x,b.position.y);
    });
  });
}

/* ===== ç”»é¢ ===== */
function startGame(e) {
  e.stopPropagation();
  document.getElementById("titleScreen").classList.add("hidden");
  document.getElementById("ui").classList.remove("hidden");
  gameActive = true;
  score = 0;
  document.getElementById("score").textContent = score;
  init();
  spawnAnimal();
}

function gameOver() {
  if (!gameActive) return;
  gameActive = false;
  document.getElementById("finalScore").textContent = score;
  document.getElementById("gameOverScreen").classList.remove("hidden");
}
</script>
</body>
</html>
