<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã©ã†ã¶ã¤ã‚¿ãƒ¯ãƒ¼ãƒãƒˆãƒ«ï¼šå…¨éƒ¨å…¥ã‚Š</title>
<style>
body { margin:0; text-align:center; background:#eef; font-family:sans-serif; }
#ui { margin:10px; }
button { font-size:16px; margin:5px; }
</style>
</head>
<body>

<h2>ğŸ¾ ã©ã†ã¶ã¤ã‚¿ãƒ¯ãƒ¼ãƒãƒˆãƒ«ï¼šã‚ªãƒªã‚¸ãƒŠãƒ«</h2>
<div id="ui">
  <button onclick="useSlow()">â¸ ã‚¹ãƒ­ãƒ¼</button>
  <span>ã‚¹ã‚³ã‚¢: <span id="score">0</span></span>
</div>

<script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
<script>
const { Engine, Render, Runner, World, Bodies, Body, Events } = Matter;

/* ================= åŸºæœ¬è¨­å®š ================= */
const engine = Engine.create();
engine.gravity.y = 1;

const render = Render.create({
  element: document.body,
  engine,
  options: { width:400, height:600, wireframes:false, background:"#fff" }
});

const runner = Runner.create();
Runner.run(runner, engine);
Render.run(render);

/* ================= åœ°é¢ ================= */
World.add(engine.world,
  Bodies.rectangle(200, 590, 400, 40, { isStatic:true, friction:1 })
);

/* ================= å‹•ç‰©å®šç¾© ================= */
const animals = [
  { emoji:"ğŸ˜", w:90, density:0.004, friction:0.9, restitution:0.05 },
  { emoji:"ğŸ§", w:60, density:0.002, friction:0.05, restitution:0.1 },
  { emoji:"ğŸ°", w:50, density:0.001, friction:0.4, restitution:0.6 },
  { emoji:"ğŸŠ", w:80, density:0.003, friction:0.6, restitution:0.05 },
  { emoji:"ğŸ", w:70, density:0.0015, friction:0.2, restitution:0.2 }
];

/* ================= çŠ¶æ…‹ ================= */
let current = null;
let score = 0;
let slowUsed = false;
let eventActive = false;

/* ================= ã‚¹ãƒãƒ¼ãƒ³ ================= */
function spawnAnimal() {
  const danger = Math.random() < 0.08 && score > 5;
  if (danger) {
    current = Bodies.circle(200, 80, 25, {
      density:0.002,
      restitution:0.9,
      render:{ text:"ğŸ’£" }
    });
  } else {
    const a = animals[Math.floor(Math.random()*animals.length)];
    current = Bodies.rectangle(200, 80, a.w, 40, {
      density:a.density,
      friction:a.friction,
      restitution:a.restitution,
      render:{ text:a.emoji }
    });
  }
  current.isSleeping = true;
  World.add(engine.world, current);
}
spawnAnimal();

/* ================= æ“ä½œ ================= */
document.addEventListener("keydown", e => {
  if (!current) return;
  if (e.key === "ArrowLeft") Body.translate(current, {x:-10,y:0});
  if (e.key === "ArrowRight") Body.translate(current, {x:10,y:0});
  if (e.key === " ") drop();
});
document.addEventListener("click", drop);

function drop() {
  if (!current) return;
  current.isSleeping = false;
  current = null;
  score++;
  document.getElementById("score").textContent = score;
  triggerWind();
  setTimeout(spawnAnimal, 600);
}

/* ================= ã‚¹ã‚­ãƒ« ================= */
function useSlow() {
  if (slowUsed) return;
  slowUsed = true;
  engine.timing.timeScale = 0.3;
  setTimeout(() => engine.timing.timeScale = 1, 3000);
}

/* ================= å¤©å€™ï¼ˆå¼·é¢¨ï¼‰ ================= */
function triggerWind() {
  if (eventActive || Math.random() > 0.3) return;
  eventActive = true;
  let t = 0;
  const wind = setInterval(() => {
    engine.world.bodies.forEach(b => {
      if (!b.isStatic) Body.applyForce(b, b.position, {x:0.0005, y:0});
    });
    t++;
    if (t > 60) {
      clearInterval(wind);
      eventActive = false;
    }
  }, 50);
}

/* ================= çˆ†å¼¾å‡¦ç† ================= */
Events.on(engine, "collisionStart", e => {
  e.pairs.forEach(p => {
    if (p.bodyA.render.text === "ğŸ’£" || p.bodyB.render.text === "ğŸ’£") {
      engine.world.bodies.forEach(b => {
        if (!b.isStatic)
          Body.applyForce(b, b.position, {
            x:(Math.random()-0.5)*0.05,
            y:-0.05
          });
      });
    }
  });
});

/* ================= çµµæ–‡å­—æç”» ================= */
Events.on(render, "afterRender", () => {
  const ctx = render.context;
  ctx.font = "30px serif";
  ctx.textAlign = "center";
  engine.world.bodies.forEach(b => {
    if (b.render.text)
      ctx.fillText(b.render.text, b.position.x, b.position.y+10);
  });
});
</script>
</body>
</html>
