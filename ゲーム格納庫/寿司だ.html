<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>å¯¿å¸æ‰“ã‚¯ãƒ­ãƒ¼ãƒ³ å®Œå…¨ç‰ˆ</title>
<style>
body{margin:0;background:#111;color:#fff;font-family:sans-serif;text-align:center}
canvas{background:#222;display:block;margin:auto}
button{font-size:18px;padding:10px 20px;margin:10px}
</style>
</head>
<body>

<h2>ğŸ£ å¯¿å¸æ‰“ã‚¯ãƒ­ãƒ¼ãƒ³ï¼ˆå®Œå…¨ç‰ˆï¼‰</h2>
<canvas id="game" width="900" height="450"></canvas>

<div id="menu">
  <button onclick="startGame()">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let state="title";
let sushiX=900;
let falling=false;
let score=0, combo=0, norm=5;
let buffer="", kanaIndex=0;

const WORDS=[
  ["ã¡ã‚ƒ","ã‚","ã‚“","ã‚€","ã—"],
  ["ãŒ","ã£","ã“","ã†"],
  ["ã","ã£","ã¦"],
  ["ã¾","ã£","ã¡ã‚ƒ"],
  ["ã™","ã—"]
];

const ROMA={
 "ã¡":["chi","ti"],
 "ã¡ã‚ƒ":["cha","cya","tya","tilya"],
 "ã—":["shi","si"],
 "ã™":["su"],
 "ã‚":["wa"],
 "ã‚“":["n","nn"],
 "ã‚€":["mu"],
 "ãŒ":["ga"],
 "ã“":["ko"],
 "ã†":["u"],
 "ã":["ki"],
 "ã¦":["te"],
 "ã¾":["ma"]
};

let kana=[], romaCand=[], romaGuide="";

function buildRomaCandidates(kana){
 let r=[];
 for(let i=0;i<kana.length;i++){
  if(kana[i]==="ã£"){
   const next=kana[i+1];
   const c=(ROMA[next]?.[0]||"")[0];
   r.push([c,"ltu","xtu"]);
  }else{
   r.push(ROMA[kana[i]]||[kana[i]]);
  }
 }
 return r;
}

function nextWord(){
 kana=WORDS[Math.floor(Math.random()*WORDS.length)];
 romaCand=buildRomaCandidates(kana);
 romaGuide=romaCand.map(r=>r[0]).join("");
 kanaIndex=0; buffer="";
 sushiX=900; falling=false;
}

function startGame(){
 state="play";
 score=0; combo=0;
 nextWord();
 loop();
}

document.addEventListener("keydown",e=>{
 if(state==="pause"){
  if(e.key==="p"||e.key==="Escape") state="play";
  return;
 }
 if(state!=="play") return;

 if(e.key==="p"||e.key==="Escape"){
  state="pause"; return;
 }

 buffer+=e.key.toLowerCase();
 const cand=romaCand[kanaIndex];

 for(const r of cand){
  if(r.startsWith(buffer)){
   if(r===buffer){
    kanaIndex++; buffer="";
    if(kanaIndex>=kana.length){
     score+=10+combo*2;
     combo++;
     nextWord();
    }
   }
   return;
  }
 }
 buffer=""; combo=0; falling=true;
});

function loop(){
 if(state!=="play"&&state!=="pause") return;
 ctx.clearRect(0,0,900,450);

 if(state==="pause"){
  ctx.fillStyle="rgba(0,0,0,0.6)";
  ctx.fillRect(0,0,900,450);
  ctx.fillStyle="#fff";
  ctx.font="32px sans-serif";
  ctx.fillText("â¸ PAUSE",380,200);
  ctx.font="18px sans-serif";
  ctx.fillText("P / ESC ã§å†é–‹",360,240);
  requestAnimationFrame(loop);
  return;
 }

 sushiX-=3;
 if(sushiX<100&&!falling){
  combo=0; falling=true;
 }
 if(falling) sushiX+=5;

 ctx.font="28px sans-serif";
 ctx.fillStyle="#fff";
 ctx.fillText(kana.join(""),sushiX,220);

 ctx.font="22px monospace";
 ctx.fillStyle="#aaa";
 ctx.fillText(romaGuide,sushiX,260);

 ctx.fillStyle="#0f0";
 ctx.fillText("Score:"+score,20,30);
 ctx.fillText("Combo:"+combo,20,60);

 if(score>=norm*10){
  ctx.fillStyle="gold";
  ctx.font="40px sans-serif";
  ctx.fillText("ğŸ CLEAR!",360,200);
  return;
 }

 requestAnimationFrame(loop);
}
</script>
</body>
</html>
